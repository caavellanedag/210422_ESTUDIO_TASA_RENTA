---
title: "Metodología para la estimación de la tasa de capitalización"
author: "Grupo estadístico - Observatorio técnico catastral (UAECD)"
header-includes:
   - \usepackage{amsmath}
   - \usepackage{graphics}
   - \usepackage[inline]{enumitem}
   - \usepackage{amsbsy}
   - \usepackage{multirow}
   - \usepackage{mathtools}
   - \usepackage{cancel}
   - \usepackage{url}
   - \usepackage{tikz}
   - \usepackage{float}
   - \usepackage{epstopdf}
   - \usepackage{enumitem}
   - \usepackage{bm}
   - \usepackage{color, colortbl}
   - \usepackage{natbib}
output:
  bookdown::pdf_document2:
    citation_package: natbib
bibliography: references.bib
---


```{r setup, include=FALSE}
require(tinytex)
options(kableExtra.latex.load_packages = FALSE)
#options( tinytex.verbose = TRUE)
knitr::opts_chunk$set(echo = TRUE)
options(tinytex.verbose = TRUE)
```




\begin{abstract}
Your abstract.
\end{abstract}

\section{Introducción}\label{section1}

En la Unidad Administrativa Especial de Catastro Distrital (UAECD) se cuenta con información de ofertas de fuentes secundarias y de fuentes primarias. Las fuentes primarias corresponden a información recolectada en campo por cuenta de la UAECD, mientras que la secundaría corresponde a información que se recolecta a partir de otras fuentes con las cuales se establecen convenios. 

Para diferentes procesos de la Unidad se hace uso de la información recolectada con respecto a ofertas de venta de predios en la ciudad, como por ejemplo en la estimación de parámetros de algunos modelos econométricos para estimar el valor integral de predios en propiedad horizontal. Sin embargo dentro de estos procesos no se tiene en cuenta la información recolectada de ofertas de arriendo, por lo cual este documento tiene como objetivo estimar la tasa de renta inmobiliaria que establezca una relación entre los valores de arriendo y los valores comerciales de los predios en la ciudad de Bogotá, de tal forma que se pueda utilizar la información de ofertas de arriendo en procesos donde se requieren valores comerciales totales de los predios. 

Denotando como $Z_i$ y $X_i$ al valor comercial y el valor de arriendo del $i$-ésimo predio, respectivamente, se busca obtener un coeficiente $\beta$, tal que se pueda obtener una ecuación que relacione a $Z_i$ y $X_i$ como se muestra en la ecuación \eqref{eq1}. De esta manera, de una forma natural se puede pensar en el uso de los rudimientos correspondientes a las metodologías de modelos lineales \citep{Melo} que permitan estimar el coeficiente $\beta$. Este ejercicio se debe realizar para diferentes desagregaciones de predios en la ciudad, tales como usos, estratos y/o desagregaciones geográficas (localidad, upz, sectores catastrales, entre otros). El nivel de desagregación depende de la cantidad de registros correspondiente a cada caso. 

\begin{equation}\label{eq1}
    Z_i=\beta X_i 
\end{equation}

En la información disponible para la realización de este documento, se encuentran las ofertas recolectadas por la UAECD tanto de fuentes primarias como secundarias en los años, 2017, 2018, 2019 y 2020. Una limitante que se debe tener en cuenta es que los predios no tienen información de arriendo y venta de manera simultánea, lo que quiere decir que para cada oferta solamente se tiene una de las dos mediciones. 

Dentro de la literatura se encuentran diversos ejemplos de este tipo de datos donde se hacen mediciones o encuestas a grupos de individuos periódicamente, pero no necesariamente a las mismas personas, lo cual imposibilita hacer seguimientos sobre unidades en particular. \cite{deaton1985panel} propone un modelo para una muestra \textit{``pseudo-panel"}, que se construye con lo que denomina como cohortes, las cuales representan grupos de individuos con características similares, con la condición que cada individuo pertenezca únicamente a una cohorte durante todo el análisis y mediante estos grupos se ajustan efectos fijos correspondientes a cada una de las diferentes cohortes. El ejemplo que se trabaja allí es la creación de las agrupaciones mediante la fecha de nacimiento de las personas, de tal forma que cada uno pertenece únicamente a un grupo en el análisis realizado. Muchas publicaciones que abordan diferentes contextos se han elaborado a partir del modelo propuesto por  \citet{deaton1985panel} (Ver \citet{tsai2014review, tovar2012analysis,sprietsma2012computers,antman2007earnings}, entre otros).

 A partir de la propuesta de \citet{deaton1985panel} se particiona la población en las cohortes mencionadas y considerando que dichos segmentos abarcan todo el conjunto, los efectos incluidos en los modelos lineales de regresión son efectos fijos, a diferencia del caso que se trabaja en este documento donde se utiliza el modelo propuesto allí,   pero además se incluyen efectos aleatorios asociados a las diferentes cohortes, debido a que generalmente se trabaja únicamente con un subconjunto de UE pertenecientes a la población objetivo y no la totalidad de unidades. 
 
Por ende, dado que no se tienen mediciones de arriendo y venta sobre los mismos predios, se propone el uso de un modelo lineal, agregando de acuerdo a "cohortes", de tal manera que se pueda emular la propuesta de \citet{deaton1985panel}. En este caso, la propuesta es agrupar por agregaciones geográficas tales como sectores catastrales, considerando que desagregar a nivel de lote puede llegar a ser demasiado fino y pueda presentar problemas a la hora de hacer la estimación de parámetros en el modelo lineal, y por otro lado a nivel de agregaciones como localidad puede generar agrupaciones muy grandes, considerando los objetivos del estudio.

El presente documento contiene en la sección \label{section_int} la introducción, seguido de la sección \label{section_obj} donde se presentan los objetivos del estudio. En la sección \ref{section_marco} se hace una revisión metodológica de las metodologías estadísticas a utilizar. Por otro lado, la sección
\section{Objetivos}\label{section_obj}

\subsection{Objetivo general}

Estimar un índice que permita relacionar los valores de arriendo de un inmueble con su valor comercial para las diferentes zonas, usos y estratos de la ciudad.


\subsection{Objetivos especificos}
 
 \begin{enumerate}
  \item   Hacer una revisión de la literatura para obtener un estado del arte, con el objetivo de tener en cuenta posibles metodologías que puedan ayudar a completar los otros objetivos específicos y/o puedan servir como metodologías de referencia a la hora de realizar una comparación dentro del mismo estudio.
   \item Realizar un análisis descriptivo de la base de datos disponible para la realización del ejercicio.
    \item Realizar una validación de las ofertas contenidas dentro de la base de datos, con el objetivo de detectar aquellas ofertas atípicas que puedan sesgar los resultados del estudio.
    \item Depurar la base de datos compartida por el OTC.
    \item Realizar el cálculo de las tasas de renta para diferentes desagregaciones de los predios en la ciudad (Uso-Estrato-Localidad/UPZ/Sector).
    \item Presentación y documentación metodológica de resultados.
    \item Evaluar la consistencia de los resultados para calcular cifras en vigencias futuras.
 \end{enumerate}
\section{Marco teórico}\label{section_marco}

\section{Modelo lineal mixto}

Los modelos lineales son una forma de explicar la dispersión de una o más respuestas aleatorias en términos de una serie de variables independientes (también conocidas como exógenas).
En \citet[p. 5]{west2014linear}
se encuentra un recuento histórico referente a los modelos lineales desde sus inicios en 1861 hasta la actualidad, desde una perspectiva teórica, mencionando al igual avances importantes en cuanto a la implementación de las diferentes metodologías a nivel de paquetes estadísticos. Éstos tienen en cuenta una serie de supuestos lo que hace posible su planteamiento, estimación, interpretación y su respectiva evaluación. 
Las variables independientes pueden ser clasificadas como efectos fijos o efectos aleatorios. Acorde con \citet[p. 6]{Melo}, cuando al finalizar el experimento las conclusiones se formulan sobre un número preestablecido de tratamientos el modelo se denomina de efectos fijos y en este caso la inferencia estadística se hace sobre los efectos medios de los tratamientos, por lo cual aquellas situaciones en que se desean realizar comparaciones o contrastes entre niveles de un factor en búsqueda de diferencias, éste se considera como fijo. Si los niveles de un atributo son una muestra aleatoria de una población de posibles selecciones, es decir, las conclusiones se formulan sobre un número mayor de tratamientos a los usados en el experimento, el modelo se dice de efectos aleatorios, y en este caso, la inferencia estadística se hace sobre las varianzas de los mismos. Los modelos que incluyen ambos se denominan de efectos mixtos (MLM).



En términos matriciales, según \citet[p. 58]{bates2000mixed}, el modelo lineal general con efectos mixtos viene dado de la forma

\begin{equation}\label{marco:modmix}
\boldsymbol{y}_i=\boldsymbol{X}_i\boldsymbol{\beta}+\boldsymbol{Z}_{i}\boldsymbol{b}_{i}+\boldsymbol{\epsilon}_i,  \enspace \text{con} \enspace i=1,\cdots,n  \enspace \text{y} \enspace n=r\times a
\end{equation}


\noindent donde $\boldsymbol{y}_i$ es el vector de respuestas, $\boldsymbol{X}_i$ y $\boldsymbol{Z}_i$ son las matrices de diseño de los efectos fijos y aleatorios  asociadas al $i$-ésimo individuo, respectivamente. Los vectores $\boldsymbol{\beta}$ y $\boldsymbol{b}_{i}$ de dimensiones $a$ y $q$, que contienen los coeficientes asociados a los efectos fijos y aleatorios considerados en la $i$-ésima UE, respectivamente, mientras que $\boldsymbol{\epsilon}_i$ es el vector de errores de mediciones dentro de cada UE. Como supuestos distribucionales sobre este modelo se asume que $\boldsymbol{b}_i \sim \boldsymbol{N}_q(\boldsymbol{0}_q,\boldsymbol{\Psi}_{q \times q})$ y $\boldsymbol{\epsilon}_i \sim \boldsymbol{N}_t(\boldsymbol{0}_t,\boldsymbol{\Sigma}_{t \times t})$. A su vez los vectores $\boldsymbol{\epsilon}_i$ y $\boldsymbol{b}_i$ se asumen independientes, es decir $Cov(\boldsymbol{\epsilon}_i,\boldsymbol{b}_i)=0$. La matriz $\boldsymbol{\Sigma}$ asociada a los residuales dentro de las mediciones de la misma unidad puede considerar diferentes situaciones, es decir que se puede asociar a procesos autocorrelacionados, por ejemplo los que se encuentran en la literatura relacionada con series de tiempo, como los modelos \textit{ARIMA} \citep{wei2006time}, o como los que se estudian en la estadística espacial, que se caracterizan mediante su función de variograma \citep{schabenberger2017statistical}. En este documento únicamente aborda el contexto de datos longitudinales o datos panel, por lo cual únicamente se tendrán en cuenta aquellos procesos relacionados con series temporales en cuanto a la matriz de errores $\boldsymbol{\Sigma}$.

\section{Revisión de la base de ofertas}

```{r include=TRUE,warning=FALSE,message=FALSE,echo=FALSE}
require(pacman)
p_load(tidyverse,openxlsx,here,haven,data.table,knitr,flextable,officer)

options(scipen=999)

source("/media/caavellanedag/MONI&CAMI/Trabajo/Catastro/210422_TASA_DE_RENTA/src/Funciones.R")
#names(base)
base <-  fread("/media/caavellanedag/MONI&CAMI/Trabajo/Catastro/210422_TASA_DE_RENTA/input/BASE_HIST_17_20_CONSOLI_FINAL_25022021.tab", header = T, sep = "\t")
base$PRECIO <- as.numeric(as.character(str_replace_all(base$PRECIO,c("\\$"="",","=""))))
base$IDENTIFICADOR <- as.character(base$IDENTIFICADOR)
base<-base %>% mutate_at(c("IDENTIFICADOR","CODIGO_UPZ","NOMBRE_UPZ","CODIGO_BARRIO","NOMBRE_BARRIO",
                     "NOMBRE_LOCALIDAD","CODIGO_LOCALIDAD","BARMANPRE"),as.character) 
base$FECHA<-as.Date(base$FECHA,format="%d/%m/%Y")
base<-as.data.table(base)
base$YEAR<-base[,"A\xd1O"]
```

```{r include=FALSE,echo=FALSE,warning=FALSE,message=FALSE}
n_fail <- sum(base$IDENTIFICADOR=="" | is.na(base$IDENTIFICADOR) | is.na(base$PRECIO) | base$BARMANPRE=="" | is.na(base$BARMANPRE))
base_filtrada <- base[!(base$IDENTIFICADOR=="" | is.na(base$IDENTIFICADOR) | is.na(base$PRECIO) | base$BARMANPRE=="" | is.na(base$BARMANPRE)),]
base_filtrada <- as.data.table(base_filtrada)


N_AC <- sum(is.na(base_filtrada$AREA_CONSTRUIDA))
N_AT <- sum((base_filtrada$TIPO_INMUEBLE!="APARTAMENTO" & is.na(base_filtrada$AREA_DE_TERRENO)))
base_filtrada <- base_filtrada[!(base_filtrada$TIPO_INMUEBLE!="APARTAMENTO" & is.na(base_filtrada$AREA_DE_TERRENO)) & !is.na(base_filtrada$AREA_CONSTRUIDA),]
```




La base de datos consta originalmente con `r labels(nrow(base))` registros. El resumen del número de registros, antes de realizar ciertas exclusiones se presenta en la siguiente tabla, la cual muestra el número de ofertas por fuente.


```{r echo=FALSE,message=FALSE,warning=FALSE}
theme_box(autofit(flextable(base[,.N,by=.(NOMBRE_FUENTE)])))
```


Inicialmente se filtraron aquellos registros que no cuentan con identificador, precio o barmanpre. Posterior a esta revisión se excluyeron los registros que no tenían área construida (`r labels(N_AC)`) y aquellos casos que no tenían área de terreno cuando el tipo de inmueble es diferente a apartamentos (`r labels(N_AT)`). A partir de esta base depurada se realizaron los siguientes conteos y gráficos de tipo descriptivo. Luego de estas exclusiones, se tiene un restante de `r labels(nrow(base_filtrada))` ofertas, las cuales son tenidas en cuenta dentro de los siguientes gráficos y tablas descriptivas.






```{r echo=FALSE,warning=FALSE,message=FALSE}
base_filtrada[,.N,by=.(TIPO_INMUEBLE)][order(TIPO_INMUEBLE),LABELS:=labels(N)][N>2000] %>% 
  ggplot()+geom_col(aes(x=fct_reorder(TIPO_INMUEBLE,N,.desc=TRUE),y=N),fill="red",position="dodge")+
  geom_text(aes(x=fct_reorder(TIPO_INMUEBLE,N,.desc=TRUE),y=N,label=LABELS),vjust=-0.6,position = position_dodge(width = 1))+ylab("N?mero de ofertas")+xlab("AÑO")+
  scale_y_continuous(labels=labels)+
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) 
```

```{r echo=FALSE,warning=FALSE,message=FALSE}
base_filtrada[TIPO_INMUEBLE %in% c("APARTAMENTO","CASA"),.N,by=.(TIPO_INMUEBLE,ESTRATO)][order(TIPO_INMUEBLE,ESTRATO),LABELS:=labels(N)] %>% 
  ggplot()+geom_col(aes(x=ESTRATO,y=N),fill="red",position="dodge")+
  geom_text(aes(x=ESTRATO,y=N,label=LABELS),vjust=-0.6,position = position_dodge(width = 1))+ylab("N?mero de ofertas")+xlab("ESTRATO")+
  scale_y_continuous(labels=function(x) format(x, big.mark = ".", scientific = FALSE))+
  scale_x_continuous(breaks=0:6)+
  facet_wrap(~TIPO_INMUEBLE,scales="free")
```

  



```{r echo=FALSE,warning=FALSE,message=FALSE}
base_filtrada[,.N,by=.(YEAR,NOMBRE_FUENTE)][order(YEAR,NOMBRE_FUENTE),LABELS:=labels(N)] %>% 
  ggplot()+geom_col(aes(x=YEAR,y=N,fill=NOMBRE_FUENTE),position="dodge")+
  geom_text(aes(x=YEAR,y=N,label=LABELS,group=NOMBRE_FUENTE),vjust=-0.6,position = position_dodge(width = 1))+ylab("Número de ofertas")+xlab("Año")+
scale_y_continuous(labels=function(x) format(x, big.mark = ".", scientific = FALSE))+scale_fill_brewer(palette="Set1")
```

```{r echo=FALSE,warning=FALSE,message=FALSE}
base_filtrada[,.N,by=.(YEAR,TIPO_OFERTA)][order(YEAR,TIPO_OFERTA),LABELS:=labels(N)] %>% 
  ggplot()+geom_col(aes(x=YEAR,y=N,fill=TIPO_OFERTA),position="dodge")+
  geom_text(aes(x=YEAR,y=N,label=LABELS,group=TIPO_OFERTA),vjust=-0.6,position = position_dodge(width = 1))+ylab("Número de ofertas")+xlab("Año")+
  scale_y_continuous(labels=function(x) format(x, big.mark = ".", scientific = FALSE))+scale_fill_brewer(palette="Set1")
```
```{r echo=FALSE,warning=FALSE,message=FALSE}
base_filtrada[,.N,by=.(YEAR,CLASE_PREDIO)][order(YEAR,CLASE_PREDIO),LABELS:=labels(N)] %>% 
  ggplot()+geom_col(aes(x=YEAR,y=N,fill=CLASE_PREDIO),position="dodge")+
  geom_text(aes(x=YEAR,y=N,label=LABELS,group=CLASE_PREDIO),vjust=-0.6,position = position_dodge(width = 1))+ylab("Número de ofertas")+xlab("Año")+
  scale_y_continuous(labels=function(x) format(x, big.mark = ".", scientific = FALSE))+scale_fill_brewer(palette="Set1")
```

```{r echo=FALSE,warning=FALSE,message=FALSE}
base_filtrada[,.N,by=.(YEAR,TIPO_INMUEBLE)][order(YEAR,TIPO_INMUEBLE),LABELS:=labels(N)][N>2000] %>% 
  ggplot()+geom_col(aes(x=fct_reorder(TIPO_INMUEBLE,N,.desc=TRUE),y=N),fill="red",position="dodge")+
  geom_text(aes(x=fct_reorder(TIPO_INMUEBLE,N,.desc=TRUE),y=N,label=LABELS),vjust=-0.6,position = position_dodge(width = 1))+ylab("N?mero de ofertas")+xlab("AÑO")+
  scale_y_continuous(labels=function(x) format(x, big.mark = ".", scientific = FALSE))+facet_wrap(~YEAR,scales="free")+
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) 
```

<!-- ```{r echo=FALSE} -->
<!-- theme_box(autofit(flextable(base_filtrada[,.N,by=.(AÑO,TIPO_INMUEBLE)][order(AÑO,TIPO_INMUEBLE)]))) -->
<!-- ``` -->

<!-- ```{r echo=FALSE} -->
<!-- theme_box(autofit(flextable(base_filtrada[,.N,by=.(AÑO,TIPO_OFERTA,NOMBRE_FUENTE)][order(AÑO,TIPO_OFERTA,NOMBRE_FUENTE),]))) -->
<!-- ``` -->



